generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model User {
  id                  String            @id @default(cuid())
  name                String
  email               String
  emailVerified       Boolean           @default(false)
  image               String?
  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt
  avatarUrl           String?
  membershipExpiresAt DateTime?
  membershipTier      String?
  role                String            @default("user")
  accounts            Account[]
  apiTokens           ApiToken[]
  blogs               Blog[]
  sessions            Session[]
  preferences         user_preferences?

  @@map("user")
}

model user_preferences {
  user_id      String   @id
  persona      String?
  default_view Json?
  created_at   DateTime @default(now())
  updated_at   DateTime @updatedAt
  user         User     @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@map("user_preferences")
}

model Session {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("session")
}

model Account {
  id                    String    @id @default(cuid())
  userId                String
  accountId             String
  providerId            String
  accessToken           String?
  refreshToken          String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  idToken               String?
  password              String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("account")
}

model Verification {
  id         String   @id @default(cuid())
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@map("verification")
}

model MembershipTier {
  id           String   @id @default(cuid())
  name         String   @unique
  slug         String   @unique
  description  String?
  priceMonthly Float
  priceYearly  Float?
  features     String[]
  requestLimit Int      @default(10000)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@map("membership_tier")
}

model ApiToken {
  id        String    @id @default(cuid())
  userId    String
  name      String
  token     String    @unique
  scopes    String[]  @default([])  
  lastUsed  DateTime?
  expiresAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  scopes    String[]  @default([])
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("api_token")
}

model Blog {
  id         String   @id @default(cuid())
  slug       String   @unique
  title      String
  excerpt    String?
  content    String
  coverImage String?
  published  Boolean  @default(false)
  authorId   String
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  author     User     @relation(fields: [authorId], references: [id], onDelete: Cascade)

  @@index([published])
  @@index([slug])
  @@map("blog")
}

model eip_category_events {
  id            BigInt        @id @default(autoincrement())
  eip_id        Int?
  repository_id Int?
  from_category String?
  to_category   String
  commit_sha    String
  changed_at    DateTime      @db.Timestamp(6)
  eips          eips?         @relation(fields: [eip_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  repositories  repositories? @relation(fields: [repository_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([eip_id, commit_sha, to_category], map: "eip_category_events_unique")
}

model eip_deadline_events {
  id                BigInt        @id @default(autoincrement())
  eip_id            Int?
  repository_id     Int?
  previous_deadline DateTime?     @db.Date
  new_deadline      DateTime?     @db.Date
  commit_sha        String
  changed_at        DateTime      @db.Timestamp(6)
  eips              eips?         @relation(fields: [eip_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  repositories      repositories? @relation(fields: [repository_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([eip_id, commit_sha], map: "eip_deadline_events_unique")
}

model eip_files {
  id             Int           @id @default(autoincrement())
  eip_id         Int?
  repository_id  Int?
  file_path      String
  valid_from_sha String
  valid_to_sha   String?
  created_at     DateTime?     @default(now()) @db.Timestamp(6)
  eips           eips?         @relation(fields: [eip_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  repositories   repositories? @relation(fields: [repository_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
}

model eip_snapshots {
  eip_id          Int           @id
  repository_id   Int?
  status          String
  type            String?
  category        String?
  deadline        DateTime?     @db.Date
  last_commit_sha String?
  updated_at      DateTime      @db.Timestamp(6)
  eips            eips          @relation(fields: [eip_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  repositories    repositories? @relation(fields: [repository_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
}

model eip_status_events {
  id            BigInt        @id @default(autoincrement())
  eip_id        Int?
  repository_id Int?
  from_status   String?
  to_status     String
  commit_sha    String
  pr_number     Int?
  changed_at    DateTime      @db.Timestamp(6)
  eips          eips?         @relation(fields: [eip_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  repositories  repositories? @relation(fields: [repository_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([eip_id, commit_sha, to_status], map: "eip_status_events_unique")
}

model eip_type_events {
  id            BigInt        @id @default(autoincrement())
  eip_id        Int?
  repository_id Int?
  from_type     String?
  to_type       String
  commit_sha    String
  changed_at    DateTime      @db.Timestamp(6)
  eips          eips?         @relation(fields: [eip_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  repositories  repositories? @relation(fields: [repository_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([eip_id, commit_sha, to_type], map: "eip_type_events_unique")
}

model eips {
  id                  Int                   @id @default(autoincrement())
  eip_number          Int                   @unique
  created_at          DateTime?             @db.Date
  title               String?
  author              String?
  eip_category_events eip_category_events[]
  eip_deadline_events eip_deadline_events[]
  eip_files           eip_files[]
  eip_snapshots       eip_snapshots?
  eip_status_events   eip_status_events[]
  eip_type_events     eip_type_events[]
}

model pgmigrations {
  id     Int      @id @default(autoincrement())
  name   String   @unique @db.VarChar(255)
  run_on DateTime @db.Timestamp(6)
}

model pull_request_eips {
  pr_number     Int
  repository_id Int
  eip_number    Int
  linked_at     DateTime     @default(now()) @db.Timestamptz(6)
  repositories  repositories @relation(fields: [repository_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@id([pr_number, repository_id, eip_number])
  @@index([eip_number], map: "pull_request_eips_eip_number_index")
  @@index([repository_id, eip_number], map: "pull_request_eips_repository_id_eip_number_index")
}

model pull_requests {
  id               Int           @id @default(autoincrement())
  pr_number        Int
  repository_id    Int?
  title            String?
  author           String?
  merged_at        DateTime?     @db.Timestamp(6)
  closed_at        DateTime?     @db.Timestamp(6)
  updated_at       DateTime?     @db.Timestamp(6)
  state            String?
  num_commits      Int?
  num_files        Int?
  num_participants Int?
  num_comments     Int?          @default(0)
  num_reviews      Int?          @default(0)
  labels           String[]      @default([])
  created_at       DateTime?     @default(now()) @db.Timestamp(6)
  body             String?
  repositories     repositories? @relation(fields: [repository_id], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@unique([pr_number, repository_id], map: "pull_requests_unique")
  @@index([labels], map: "idx_pull_requests_labels", type: Gin)
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model repositories {
  id                   Int                    @id @default(autoincrement())
  name                 String                 @unique
  type                 String?
  active               Boolean?               @default(true)
  contributor_activity contributor_activity[]
  contributor_scores   contributor_scores[]
  eip_category_events  eip_category_events[]
  eip_deadline_events  eip_deadline_events[]
  eip_files            eip_files[]
  eip_snapshots        eip_snapshots[]
  eip_status_events    eip_status_events[]
  eip_type_events      eip_type_events[]
  issue_custom_tags    issue_custom_tags[]
  issue_eips           issue_eips[]
  issue_events         issue_events[]
  issues               issues[]
  pr_custom_tags       pr_custom_tags[]
  pr_events            pr_events[]
  pr_governance_state  pr_governance_state[]
  pr_label_snapshot    pr_label_snapshot[]
  pr_monthly_snapshot  pr_monthly_snapshot[]
  pr_reviews           pr_reviews[]
  pull_request_eips    pull_request_eips[]
  pull_requests        pull_requests[]
}

model rip_commits {
  id            BigInt   @id @default(autoincrement())
  rip_id        Int?
  commit_sha    String
  commit_date   DateTime @db.Timestamp(6)
  author        String?
  message       String?
  files_changed Int?
  insertions    Int?
  deletions     Int?
  repo          String?  @default("RIPs")
  rips          rips?    @relation(fields: [rip_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([rip_id, commit_sha], map: "rip_commits_unique")
}

model rips {
  id          Int           @id @default(autoincrement())
  rip_number  Int           @unique
  title       String?
  status      String?
  author      String?
  created_at  DateTime?     @default(now()) @db.Timestamp(6)
  rip_commits rip_commits[]
}

model scheduler_state {
  key        String    @id
  value      String?
  updated_at DateTime? @default(now()) @db.Timestamp(6)
}

model contributor_activity {
  id            BigInt        @id @default(autoincrement())
  pr_number     Int
  repository_id Int?
  actor         String
  role          String?
  action_type   String
  occurred_at   DateTime      @db.Timestamp(6)
  repositories  repositories? @relation(fields: [repository_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([actor], map: "contributor_activity_actor_index")
  @@index([repository_id, occurred_at], map: "contributor_activity_repository_id_occurred_at_index")
}

model pr_events {
  id            BigInt        @id @default(autoincrement())
  pr_number     Int
  repository_id Int?
  event_type    String
  actor         String
  actor_role    String?
  commit_sha    String?
  github_id     String?       @unique
  metadata      Json?
  created_at    DateTime      @db.Timestamp(6)
  repositories  repositories? @relation(fields: [repository_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([repository_id, pr_number], map: "pr_events_repository_id_pr_number_index")
}

model pr_governance_state {
  pr_number       Int
  repository_id   Int
  current_state   String
  waiting_since   DateTime?    @db.Timestamp(6)
  last_actor      String?
  last_event_type String?
  updated_at      DateTime?    @default(now()) @db.Timestamp(6)
  repositories    repositories @relation(fields: [repository_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@id([repository_id, pr_number])
}

model upgrade_composition_current {
  upgrade_id Int
  eip_number Int
  bucket     String?
  updated_at DateTime? @db.Timestamp(6)

  @@id([upgrade_id, eip_number])
}

model upgrade_composition_events {
  id          BigInt    @id @default(autoincrement())
  upgrade_id  Int?
  meta_eip    Int?
  eip_number  Int?
  bucket      String?
  event_type  String?
  commit_sha  String?
  commit_date DateTime? @db.Timestamp(6)
  created_at  DateTime? @default(now()) @db.Timestamp(6)
  upgrades    upgrades? @relation(fields: [upgrade_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([upgrade_id, commit_sha, eip_number, bucket, event_type], map: "upgrade_composition_events_unique")
}

model upgrades {
  id                         Int                          @id @default(autoincrement())
  slug                       String                       @unique
  name                       String?
  meta_eip                   Int?
  repo                       String?
  file_path                  String?
  created_at                 DateTime?                    @default(now()) @db.Timestamp(6)
  upgrade_composition_events upgrade_composition_events[]
  upgrade_meta_eip_events    upgrade_meta_eip_events[]
}

model contributor_scores {
  id             Int           @id @default(autoincrement())
  actor          String
  repository_id  Int?
  total_score    Int?          @default(0)
  commits_count  Int?          @default(0)
  prs_created    Int?          @default(0)
  prs_merged     Int?          @default(0)
  reviews_count  Int?          @default(0)
  comments_count Int?          @default(0)
  first_activity DateTime?     @db.Timestamptz(6)
  last_activity  DateTime?     @db.Timestamptz(6)
  updated_at     DateTime?     @default(now()) @db.Timestamptz(6)
  repositories   repositories? @relation(fields: [repository_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([actor, repository_id])
  @@index([actor], map: "idx_contributor_scores_actor")
  @@index([total_score], map: "idx_contributor_scores_score")
}

model issue_custom_tags {
  id            Int          @id @default(autoincrement())
  issue_number  Int
  repository_id Int
  tag           String       @db.VarChar(100)
  created_at    DateTime?    @default(now()) @db.Timestamptz(6)
  repositories  repositories @relation(fields: [repository_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([issue_number, repository_id, tag])
  @@index([issue_number, repository_id], map: "idx_issue_custom_tags_issue")
  @@index([tag], map: "idx_issue_custom_tags_tag")
}

model issue_events {
  id            BigInt       @id @default(autoincrement())
  issue_number  Int
  repository_id Int
  event_type    String
  actor         String
  actor_role    String?
  github_id     String?      @unique
  metadata      Json?
  created_at    DateTime     @db.Timestamptz(6)
  repositories  repositories @relation(fields: [repository_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([repository_id, issue_number], map: "idx_issue_events_repo")
}

model issues {
  id            Int          @id @default(autoincrement())
  issue_number  Int
  repository_id Int
  title         String?
  author        String?
  state         String?
  created_at    DateTime?    @db.Timestamptz(6)
  updated_at    DateTime?    @db.Timestamptz(6)
  closed_at     DateTime?    @db.Timestamptz(6)
  labels        String[]     @default([])
  num_comments  Int?         @default(0)
  body          String?
  repositories  repositories @relation(fields: [repository_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([issue_number, repository_id])
  @@index([created_at], map: "idx_issues_created")
  @@index([labels], map: "idx_issues_labels", type: Gin)
  @@index([repository_id, state], map: "idx_issues_repo_state")
}

model pr_custom_tags {
  id            Int          @id @default(autoincrement())
  pr_number     Int
  repository_id Int
  tag           String       @db.VarChar(100)
  created_at    DateTime?    @default(now()) @db.Timestamptz(6)
  repositories  repositories @relation(fields: [repository_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([pr_number, repository_id, tag])
  @@index([pr_number, repository_id], map: "idx_pr_custom_tags_pr")
  @@index([tag], map: "idx_pr_custom_tags_tag")
}

model insights_monthly {
  month_year String   @id
  summary    Json
  highlights Json?
  created_at DateTime @default(now()) @db.Timestamptz(6)
}

model issue_eips {
  issue_number  Int
  repository_id Int
  eip_number    Int
  linked_at     DateTime     @default(now()) @db.Timestamptz(6)
  repositories  repositories @relation(fields: [repository_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@id([issue_number, repository_id, eip_number])
  @@index([eip_number], map: "issue_eips_eip_number_index")
  @@index([repository_id, eip_number], map: "issue_eips_repository_id_eip_number_index")
}

model pr_label_snapshot {
  pr_number     Int
  repository_id Int
  month_year    String
  labels        String[]     @default([])
  created_at    DateTime     @default(now()) @db.Timestamptz(6)
  repositories  repositories @relation(fields: [repository_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@id([repository_id, pr_number, month_year])
  @@index([month_year], map: "idx_pr_label_snapshot_month")
}

model pr_monthly_board_stats {
  month_year   String
  category     String
  subcategory  String
  count        Int      @default(0)
  last_updated DateTime @default(now()) @db.Timestamptz(6)

  @@id([month_year, category, subcategory])
  @@index([month_year], map: "idx_pr_monthly_board_stats_month")
}

model pr_monthly_snapshot {
  pr_number        Int
  repository_id    Int
  month_year       String
  state            String
  governance_state String?
  labels           String[]     @default([])
  created_at       DateTime     @default(now()) @db.Timestamptz(6)
  repositories     repositories @relation(fields: [repository_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@id([repository_id, pr_number, month_year])
  @@index([month_year, state], map: "idx_pr_monthly_snapshot_month_state")
}

model pr_reviews {
  id            BigInt       @id @default(autoincrement())
  pr_number     Int
  repository_id Int
  reviewer      String
  review_state  String
  submitted_at  DateTime     @db.Timestamptz(6)
  github_id     String?      @unique
  repositories  repositories @relation(fields: [repository_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([repository_id, reviewer], map: "pr_reviews_repository_id_reviewer_index")
  @@index([submitted_at], map: "pr_reviews_submitted_at_index")
}

model scheduler_runs {
  id                   BigInt    @id @default(autoincrement())
  started_at           DateTime  @default(now()) @db.Timestamptz(6)
  finished_at          DateTime? @db.Timestamptz(6)
  status               String    @default("running")
  last_repo            String?
  error                String?
  records_ingested     Int       @default(0)
  rate_limit_remaining Int?

  @@index([started_at], map: "idx_scheduler_runs_started_at")
}

model upgrade_meta_eip_events {
  id         BigInt   @id @default(autoincrement())
  upgrade_id Int
  from_eip   Int?
  to_eip     Int
  commit_sha String
  changed_at DateTime @db.Timestamptz(6)
  upgrades   upgrades @relation(fields: [upgrade_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([upgrade_id, changed_at], map: "idx_upgrade_meta_eip_events_upgrade_changed")
}